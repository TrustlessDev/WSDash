<!DOCTYPE html>
<html>
  <head>
    <title>管理介面</title>
    <meta charset="utf-8" />
    <meta HTTP-EQUIV="EXPIRES" CONTENT="Mon, 22 Jul 2002 11:12:01 GMT">
    <script type="text/javascript" src="js/jquery-3.6.1.min.js"></script>
    <style>
        #treeView  {
            float: left
        }

        #screenView  {
            float: right
        }

        .xicon {
            float: left
        }

        .xname {
            float: right
        }
    </style>
  </head>
  <body>
    <p>管理介面</p>

    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize_button" onclick="handleAuthClick()">登入</button>
    <button id="signout_button" onclick="handleSignoutClick()">登出</button>

    <pre id="content" style="white-space: pre-wrap;"></pre>

    <hr>
    <div id="wrap">
        <div id="treeView">
            <div id="tree"></div>
        </div>
        <div id="screenView">
            <img id="screen" style="width:1080px;text-align:left">
        </div>
    </div>
    
    <div id="keyRecord">

    </div>
    
    <script type="text/javascript">
        const CLIENT_ID = '366215724019-qqo1q5nlos02ac5ii4a55sfqqrs04tsl.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCBywDDiNawTCa4fXeO6teysyZxtaNaUgg';

        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.metadata.readonly';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let socket = null;
        let userId = "";

        document.getElementById('authorize_button').style.visibility = 'hidden';
        document.getElementById('signout_button').style.visibility = 'hidden';

        let rnd_id = uuidv4();
        
        var screenImg = document.getElementById("screen");
        screenImg.onmousemove = moveTrigger;
        screenImg.onmousedown = timerTrigger;
        screenImg.onmouseup = clickTrigger;
        
        window.addEventListener('contextmenu', (event) => {
            event.preventDefault()
        })

        function findPosition(oElement){
            if(typeof( oElement.offsetParent ) != "undefined"){
                for(var posX = 0, posY = 0; oElement; oElement = oElement.offsetParent){
                    posX += oElement.offsetLeft;
                    posY += oElement.offsetTop;
                }
                return [ posX, posY ];
            }
            else
            {
                return [ oElement.x, oElement.y ];
            }
        }

        let downTimer = null;

        function timerTrigger(e) {
            downTimer = new Date();
        }

        function moveTrigger(e) {
            let pos = getCoordinates(e);
            send(userId + "," + pos.x + "," + pos.y, "SET_CURSOR");
        }

        function clickTrigger(e) {
            let upTimer = new Date();
            let diffMs = (upTimer - downTimer);
            let pos = getCoordinates(e);
            if(diffMs > 500 || e.button == 2) {
                send(userId + "," + pos.x + "," + pos.y, "RIGHT_CLICK");
                console.log("Right Click");
            } else {
                send(userId + "," + pos.x + "," + pos.y, "LEFT_CLICK");
                console.log("Left Click");
            }
        }

        function getCoordinates(e){
            var PosX = 0;
            var PosY = 0;
            var ImgPos;
            ImgPos = findPosition(screenImg);
            if (!e) var e = window.event;
            if (e.pageX || e.pageY)
            {
                PosX = e.pageX;
                PosY = e.pageY;
            }
            else if (e.clientX || e.clientY)
                {
                PosX = e.clientX + document.body.scrollLeft
                    + document.documentElement.scrollLeft;
                PosY = e.clientY + document.body.scrollTop
                    + document.documentElement.scrollTop;
                }
            PosX = PosX - ImgPos[0];
            PosY = PosY - ImgPos[1];

            let nWidth = screenImg.naturalWidth;
            let width = screenImg.clientWidth;
            let ration = nWidth / width;
            let mx = Math.round(PosX * ration);
            let my = Math.round(PosY * ration);
            return {
                x: mx,
                y: my
            }
        }

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('authorize_button').style.visibility = 'visible';
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                throw (resp);
                }
                document.getElementById('signout_button').style.visibility = 'visible';
                document.getElementById('authorize_button').innerText = '重新整理';
                await listUsers('1DyegqnCILVvZVylrLXZxaVOO9wuQKkJw');
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('content').innerText = '';
                document.getElementById('authorize_button').innerText = 'Authorize';
                document.getElementById('signout_button').style.visibility = 'hidden';
            }
        }

        function send(data,cmd) {
            try {
                socket.send(rnd_id + ":" + cmd + ":" + data);
            } catch (e) {
                console.log(e);
            }
        }

        function addFolder(folderName, path) {
            let folder = document.createElement("div");
            folder.className = "folder";
            let icon = document.createElement("img");
            icon.src = "images/folder-closed.gif";
            icon.className = "xicon";
            let name = document.createElement("div");
            name.className = "xname";
            name.innerText = folderName;
            folder.appendChild(icon);
            folder.appendChild(name);
            let br = document.createElement("br");
            folder.appendChild(br);
            document.getElementById("tree").appendChild(folder);
        }

        function addFile(fileName, path) {
            let file = document.createElement("div");
            file.className = "folder";
            let icon = document.createElement("img");
            icon.src = "images/file.gif";
            icon.className = "xicon";
            let name = document.createElement("div");
            name.className = "xname";
            name.innerText = fileName;
            file.appendChild(icon);
            file.appendChild(name);
            let br = document.createElement("br");
            file.appendChild(br);
            document.getElementById("tree").appendChild(file);
        }

        function connect() {
            socket = new WebSocket("wss://ws-log.herokuapp.com");
            socket.onmessage = function(e) {
                let data = e.data.split(":");
                console.log(data);
                let uid = data[0];
                let cmd = data[1];
                let val = data[2];
                if(uid == userId) {
                    console.log(cmd);
                    if(cmd == "key") {
                        $("#keyRecord").append(val);
                    } else if(cmd == "screen") {
                        $("#screen").attr("src", "data:image/png;base64, " + val);
                    } else if(cmd == "file_system") {
                        let allFiles = val.split(",");
                        console.log(data);
                        for(let i=0;i<allFiles.length;i++){
                            let file = allFiles[i].split("|");
                            if(file[1] == "FOLDER") {
                                addFolder(file[0]);
                            } else {
                                addFile(file[0]);
                            }
                        }
                    }
                }
            };
            socket.onclose = function(e) {
              setTimeout(function(){
                connect();
              }, 1000);  
            };

            socket.onerror = function(err){
                socket.close();
            };
        }

        async function listUsers(folderId) {
            connect();
            let files = await listFiles(folderId);
            if (!files || files.length == 0) {
                document.getElementById('content').innerText = 'No files found.';
                return;
            }
            let output = "<h2>請選擇使用者名稱</h2>";
            for(let i=0;i<files.length;i++) {
                output+= "<button onclick=\"showUser('" + files[i].name + "')\">" + files[i].name + "</button>";
            }
            document.getElementById('content').innerHTML = output;
        }

        async function listFiles(folderId) {
            let response;
            try {
                response = await gapi.client.drive.files.list({
                    'q': `'${folderId}' in parents`,
                    'pageSize': 10,
                    'fields': 'files(id, name)',
                });
            } catch (err) {
                document.getElementById('content').innerText = err.message;
                return;
            }
            return response.result.files;
        }

        function showUser(uid) {
            $("#keyRecord").html("");
            userId = uid;
            $("#screen").attr("src", "");
            $("#tree").html("");
            send(userId, "SCREEN_START");
            send(userId + ",ROOT", "SHOW_FOLDER");
        }

        function uuidv4() {
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        function showScreen(uid) {
            const canvasElt = document.querySelector('canvas');
            const stream = canvasElt.captureStream(25);
            var call = peer.call(uid, stream);
            call.on('stream', function(remoteStream) {
                console.log("Online");
            });
        }

    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>
</html>